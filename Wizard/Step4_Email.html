<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>
    <meta name="cwps-meta-v-id" content="@version" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        .nav-link {
            color: white;
        }

        .nav-link:hover {
            color: yellow;
        }

        .text-danger {
            color: yellow !important;
        }

        a:hover {
            color: yellow;
        }

        a {
            color: wheat;
        }

        .setup-wizard {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .setup-step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .setup-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-bottom: 3px solid #dee2e6;
            color: #6c757d;
        }

        .setup-step.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }

        .setup-step.completed {
            border-bottom-color: #28a745;
            color: #28a745;
        }

        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }

        .test-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .test-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* Highlight validation errors */
        .input-validation-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .field-validation-error {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875em;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    @await RenderSectionAsync("Styles", false)
</head>

<body class="cwps-body bg-dark text-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <!-- Toggle button -->
        <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarCenteredExample"
            aria-controls="navbarCenteredExample" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Collapsible wrapper -->
        <div class="collapse navbar-collapse justify-content-center" id="navbarCenteredExample">
            <!-- Left links -->
            <ul class="navbar-nav mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/">
                        <img src="/images/skycms/SkyCMSLogoNoWiTextDarkTransparent30h.png" height="30" />
                    </a>
                </li>
            </ul>
            <!-- Left links -->
        </div>
        <!-- Collapsible wrapper -->
    </nav>
    <div id="main-content" class="main-content">
        <div class="container m-y-lg">
            <main class="main-primary">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <h2>Email Configuration</h2>
                        <p class="text-muted">Configure email services for notifications and user management (optional)
                        </p>

                        <div class="alert alert-info mb-4">
                            <strong><i class="fas fa-info-circle"></i> Optional Step:</strong>
                            Email configuration is not required to complete setup. You can skip this step and configure
                            email later.
                        </div>

                        <form method="post" id="emailForm">
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                            <div class="card mb-4 bg-secondary text-light">
                                <div class="card-header">
                                    <h5>Email Provider</h5>
                                </div>
                                <div class="card-body">

                                    <div class="form-group mb-3">
                                        <div id="senderEmailAlert" class="alert alert-primary" role="alert"
                                            style="display:none;">
                                            The email address used to send system emails is already set and cannot be
                                            changed.
                                        </div>
                                        <label asp-for="SenderEmail" class="form-label">Sender Email Address <span
                                                class="text-danger provider-required">*</span></label>
                                        <input asp-for="SenderEmail" type="email" class="form-control" />
                                        <span asp-validation-for="SenderEmail" class="text-danger"></span>
                                    </div>
                                    <div class="form-group mb-3">
                                        <div id="emailProviderAlert" class="alert alert-primary" role="alert"
                                            style="display:none;">
                                            Email provider settings already set and cannot be changed.
                                        </div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label class="form-label">Select Email Provider</label>
                                        <select asp-for="EmailProvider" class="form-select" id="emailProviderSelect">
                                            <option value="none">-- Skip Email Configuration (not for production) --
                                            </option>
                                            <option value="SendGrid">SendGrid</option>
                                            <option value="AzureCommunication">Azure Communication Services</option>
                                            <option value="SMTP">SMTP Server</option>
                                        </select>
                                    </div>

                                    <!-- SendGrid Options -->
                                    <div id="sendGridOptions" class="d-none">
                                        <div class="alert alert-info">
                                            <strong>SendGrid:</strong> Popular email service with generous free tier.
                                            <a href="https://sendgrid.com" target="_blank">Sign up <i
                                                    class="fas fa-external-link-alt"></i></a>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label asp-for="SendGridApiKey" class="form-label">SendGrid API Key <span
                                                    class="text-danger provider-required">*</span></label>
                                            <input asp-for="SendGridApiKey" type="password"
                                                class="form-control font-monospace" />
                                            <span asp-validation-for="SendGridApiKey" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <!-- Azure Communication Services Options -->
                                    <div id="azureCommOptions" class="d-none">
                                        <div class="alert alert-info">
                                            <strong>Azure Communication Services:</strong> Enterprise email service from
                                            Microsoft Azure.
                                            <a href="https://azure.microsoft.com/services/communication-services/"
                                                target="_blank">
                                                Learn more <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label asp-for="AzureEmailConnectionString" class="form-label">Connection
                                                String <span class="text-danger provider-required">*</span></label>
                                            <textarea asp-for="AzureEmailConnectionString"
                                                class="form-control font-monospace" rows="2"></textarea>
                                            <span asp-validation-for="AzureEmailConnectionString"
                                                class="text-danger"></span>
                                        </div>
                                    </div>

                                    <!-- SMTP Options -->
                                    <div id="smtpOptions" class="d-none">
                                        <div class="alert alert-info">
                                            <strong>SMTP:</strong> Use any SMTP server (Gmail, Outlook, custom mail
                                            server)
                                        </div>
                                        <div class="form-group mb-3">
                                            <label asp-for="SmtpHost" class="form-label">SMTP Host <span
                                                    class="text-danger provider-required">*</span></label>
                                            <input asp-for="SmtpHost" type="text" class="form-control"
                                                placeholder="smtp.gmail.com" />
                                            <span asp-validation-for="SmtpHost" class="text-danger"></span>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label asp-for="SmtpPort" class="form-label">SMTP Port <span
                                                    class="text-danger provider-required">*</span></label>
                                            <input asp-for="SmtpPort" type="number" class="form-control" value="587" />
                                            <span asp-validation-for="SmtpPort" class="text-danger"></span>
                                            <small class="form-text text-muted">Common ports: 587 (TLS), 465 (SSL), 25
                                                (plain)</small>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label asp-for="SmtpUsername" class="form-label">Username <span
                                                    class="text-danger provider-required">*</span></label>
                                            <input asp-for="SmtpUsername" type="text" class="form-control" />
                                            <span asp-validation-for="SmtpUsername" class="text-danger"></span>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label asp-for="SmtpPassword" class="form-label">Password <span
                                                    class="text-danger provider-required">*</span></label>
                                            <input asp-for="SmtpPassword" type="password" class="form-control" />
                                            <span asp-validation-for="SmtpPassword" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <div class="mt-3" id="testEmailButton" style="display: none;">
                                        <button type="submit" asp-page-handler="TestEmail"
                                            class="btn btn-sm btn-secondary">
                                            <i class="fas fa-envelope"></i> Send Test Email
                                        </button>
                                    </div>

                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <a href="" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    Next <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>

                        </form>

                    </div>
                </div>
                @section Scripts {
                <script>
                    $(document).ready(function () {
                        var form = $('#emailForm');

                        var isPreConfigured = false;
                        var isSenderEmailPreConfigured = false;

                        if (isPreConfigured) {
                            $('#sendGridOptions input, #sendGridOptions textarea, #azureCommOptions input, #azureCommOptions textarea, #smtpOptions input, #smtpOptions textarea, #emailProviderSelect').prop('readonly', true);
                            $('#emailProviderAlert').show();
                            // Disable all inputs
                        }

                        if (isSenderEmailPreConfigured) {
                            $('#SenderEmail').prop('readonly', true);
                            $('#senderEmailAlert').show();
                        } else {
                            $('#SenderEmail').prop('readonly', false);
                        }

                        // Configure validation
                        $.validator.setDefaults({
                            highlight: function (element) {
                                $(element).addClass('is-invalid').removeClass('is-valid');
                            },
                            unhighlight: function (element) {
                                $(element).removeClass('is-invalid').addClass('is-valid');
                            },
                            errorElement: 'span',
                            errorClass: 'text-danger',
                            errorPlacement: function (error, element) {
                                error.insertAfter(element);
                            }
                        });

                        function updateEmailOptions() {
                            const provider = $('#emailProviderSelect').val();

                            // Hide all options and remove required attributes
                            $('#sendGridOptions, #azureCommOptions, #smtpOptions').addClass('d-none');
                            $('#testEmailButton').hide();
                            $('input, textarea', '#sendGridOptions, #azureCommOptions, #smtpOptions').removeAttr('required');

                            switch (provider) {
                                case '':
                                case 'none':
                                    $('#sendGridOptions, #azureCommOptions, #smtpOptions').addClass('d-none');
                                    break;
                                case 'SendGrid':
                                    $('#sendGridOptions').removeClass('d-none');
                                    if (isPreConfigured) {
                                        $('#testEmailButton').show();
                                        $('input[name="SendGridApiKey"]').attr('required', 'required');
                                        $('input[name="SenderEmail"]').attr('required', 'required');
                                        break;
                                    }
                                    break;
                                case 'AzureCommunication':
                                    $('#azureCommOptions').removeClass('d-none');
                                    $('#testEmailButton').show();
                                    $('textarea[name="AzureEmailConnectionString"]').attr('required', 'required');
                                    $('input[name="SenderEmail"]').attr('required', 'required');
                                    break;
                                case 'SMTP':
                                    $('#smtpOptions').removeClass('d-none');
                                    $('#testEmailButton').show();
                                    $('#smtpOptions input').attr('required', 'required');
                                    break;
                            }

                            // Revalidate the form
                            form.validate().resetForm();
                        }

                        $('#emailProviderSelect').change(updateEmailOptions);
                        updateEmailOptions();
                    });
                </script>
                }

            </main>
        </div>
    </div>
    <footer id="footer" class="footer">
        <div class="container">
            <div class="row">
                <div class="three-quarters">
                </div>
                <div class="quarter text-right">
                    <ul class="socialsharer-container">
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
        crossorigin="anonymous"></script>
    <script src="~/lib/jquery-validate/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
</body>

</html>