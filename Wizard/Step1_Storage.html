<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width" />
    <title>@ViewBag.Title</title>
    <meta name="cwps-meta-v-id" content="@version" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    <style>
        .nav-link {
            color: white;
        }

        .nav-link:hover {
            color: yellow;
        }

        .text-danger {
            color: yellow !important;
        }

        a:hover {
            color: yellow;
        }

        a {
            color: wheat;
        }

        .setup-wizard {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .setup-step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .setup-step {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-bottom: 3px solid #dee2e6;
            color: #6c757d;
        }

        .setup-step.active {
            border-bottom-color: #007bff;
            color: #007bff;
            font-weight: bold;
        }

        .setup-step.completed {
            border-bottom-color: #28a745;
            color: #28a745;
        }

        .test-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
        }

        .test-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .test-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        /* Highlight validation errors */
        .input-validation-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .field-validation-error {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875em;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    @await RenderSectionAsync("Styles", false)
</head>

<body class="cwps-body bg-dark text-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <!-- Toggle button -->
        <button class="navbar-toggler" type="button" data-mdb-toggle="collapse" data-mdb-target="#navbarCenteredExample"
            aria-controls="navbarCenteredExample" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Collapsible wrapper -->
        <div class="collapse navbar-collapse justify-content-center" id="navbarCenteredExample">
            <!-- Left links -->
            <ul class="navbar-nav mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="/">
                        <img src="/images/skycms/SkyCMSLogoNoWiTextDarkTransparent30h.png" height="30" />
                    </a>
                </li>
            </ul>
            <!-- Left links -->
        </div>
        <!-- Collapsible wrapper -->
    </nav>
    <div id="main-content" class="main-content">
        <div class="container m-y-lg">
            <main class="main-primary">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        @await Html.PartialAsync("_SetupStepIndicator", 1)

                        <h2>Storage Configuration</h2>
                        <p class="text-muted">Configure your cloud storage for static assets</p>

                        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
                        {
                        <div class="alert alert-danger">
                            <strong>Error:</strong> @Model.ErrorMessage
                        </div>
                        }

                        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
                        {
                        <div class="alert alert-success">
                            <strong>Success:</strong> @Model.SuccessMessage
                        </div>
                        }

                        <form method="post" id="storageForm">
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                            @Html.AntiForgeryToken()
                            @Html.HiddenFor(m => m.SetupId)
                            @Html.HiddenFor(m => m.IsPreConfigured)
                            <div class="card mb-4 bg-secondary text-light">
                                <div class="card-header">
                                    <h5>Storage Provider</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Select Storage Type <span
                                                class="text-danger">*</span></label>
                                        <select asp-for="StorageType" class="form-select" id="storageTypeSelect"
                                            required>
                                            <option value="">-- Select Storage Provider --</option>
                                            <option value="AzureBlob">Azure Blob Storage</option>
                                            <option value="AmazonS3">Amazon S3</option>
                                            <option value="CloudflareR2">Cloudflare R2</option>
                                        </select>
                                        <span asp-validation-for="StorageType" class="text-danger"></span>
                                    </div>

                                    <div class="form-group mb-3">
                                        <div id="storageConnectionStringAlert" class="alert alert-primary" role="alert"
                                            style="display:none;">
                                            Connection string already set and cannot be changed.
                                        </div>
                                        <label asp-for="StorageConnectionString" class="form-label">Connection String
                                            <span class="text-danger">*</span></label>
                                        <input asp-for="StorageConnectionString" class="form-control font-monospace"
                                            required />
                                        <span asp-validation-for="StorageConnectionString" class="text-danger"></span>
                                    </div>

                                    <div id="azureBlobOptions" class="d-none">
                                        <div class="alert alert-info">
                                            <strong>Azure Blob Storage Format:</strong><br />
                                            <code>DefaultEndpointsProtocol=https;AccountName=youraccount;AccountKey=yourkey;EndpointSuffix=core.windows.net</code><br />
                                            <small>Or use Managed Identity:
                                                <code>AccountName=youraccount;AccountKey=AccessToken</code></small>
                                        </div>
                                        <div class="form-group mb-3" style="display:none;">
                                            <label asp-for="ContainerName" class="form-label">Container Name</label>
                                            <input asp-for="ContainerName" class="form-control" placeholder="$web"
                                                value="$web" />
                                            <small class="form-text text-light">Default: $web (for static
                                                websites)</small>
                                        </div>
                                    </div>

                                    <div id="amazonS3Options" class="d-none">
                                        <div class="alert alert-info">
                                            <strong>Amazon S3 Format:</strong><br />
                                            <code>Bucket=your-bucket;Region=us-east-1;KeyId=YOUR_ACCESS_KEY;Key=YOUR_SECRET_KEY;</code>
                                        </div>
                                    </div>

                                    <div id="cloudflareR2Options" class="d-none">
                                        <div class="alert alert-info">
                                            <strong>Cloudflare R2 Format:</strong><br />
                                            <code>AccountId=your-account-id;Bucket=your-bucket;KeyId=YOUR_ACCESS_KEY;Key=YOUR_SECRET_KEY;</code>
                                        </div>
                                    </div>

                                    <div id="fgBlobUrl" class="form-group mb-3">
                                        <div id="blobPublicUrlAlert" class="alert alert-primary" role="alert"
                                            style="display:none;">
                                            The public URL is already set and cannot be changed.
                                        </div>
                                        <label asp-for="BlobPublicUrl" class="form-label">Public URL (or CDN Endpoint)
                                            <span class="text-danger">*</span></label>
                                        <input asp-for="BlobPublicUrl" class="form-control"
                                            placeholder="https://cdn.example.com or /" value="/" required />
                                        <span asp-validation-for="BlobPublicUrl" class="text-danger"></span>
                                        <small class="form-text text-light">
                                            Enter "/" for static websites, or your CDN URL (e.g.,
                                            https://cdn.example.com)
                                        </small>
                                    </div>

                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <a href="@Url.Page(" ./Step1_Mode")" class="btn btn-secondary">
                                    <i class="fas fa-arrow-left"></i> Back
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    Next <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>

                        </form>

                        @section Scripts {
                        <script>
                            var isPreConfigured = @Model.IsPreConfigured.ToString().ToLower();
                            var blobPublicUrlPreConfigured = @Model.BlobPublicUrlPreConfigured.ToString().ToLower();

                            $(document).ready(function () {
                                // Enable jQuery validation
                                var form = $('#storageForm');

                                if (isPreConfigured) {
                                    $('#storageConnectionStringAlert').show();
                                    $('#fgBlobUrl').hide();

                                    // Disable storage-related inputs but keep SetupId enabled for binding
                                    $('#StorageConnectionString, #storageTypeSelect, #ContainerName').prop('disabled', true);

                                    // Make them visually readonly
                                    $('#StorageConnectionString').addClass('bg-secondary').attr('readonly', true);
                                }
                                else if (blobPublicUrlPreConfigured) {
                                    // Rare cases public URL is set while storage isn't preconfigured.
                                    $('#BlobPublicUrl').addClass('bg-secondary').attr('readonly', true);
                                    $('#blobPublicUrlAlert').prop('disabled', true);
                                    $('#blobPublicUrlAlert').show();
                                }

                                // Configure validation
                                $.validator.setDefaults({
                                    highlight: function (element) {
                                        $(element).addClass('is-invalid').removeClass('is-valid');
                                    },
                                    unhighlight: function (element) {
                                        $(element).removeClass('is-invalid').addClass('is-valid');
                                    },
                                    errorElement: 'span',
                                    errorClass: 'text-danger',
                                    errorPlacement: function (error, element) {
                                        error.insertAfter(element);
                                    }
                                });

                                // Add custom validation for storage type
                                $('#storageTypeSelect').rules('add', {
                                    required: true,
                                    messages: {
                                        required: "Please select a storage provider"
                                    }
                                });

                                function updateStorageHelp() {
                                    const storageType = $('#storageTypeSelect').val();

                                    $('#azureBlobOptions, #amazonS3Options, #cloudflareR2Options').addClass('d-none');

                                    if (!isPreConfigured) {
                                        switch (storageType) {
                                            case 'AzureBlob':
                                                $('#azureBlobOptions').removeClass('d-none');
                                                break;
                                            case 'AmazonS3':
                                                $('#amazonS3Options').removeClass('d-none');
                                                break;
                                            case 'CloudflareR2':
                                                $('#cloudflareR2Options').removeClass('d-none');
                                                break;
                                        }
                                    }
                                }

                                $('#storageTypeSelect').change(updateStorageHelp);
                                updateStorageHelp();
                            });
                        </script>
                        }

                    </div>
                </div>
            </main>
        </div>
    </div>
    <footer id="footer" class="footer">
        <div class="container">
            <div class="row">
                <div class="three-quarters">
                </div>
                <div class="quarter text-right">
                    <ul class="socialsharer-container">
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8"
        crossorigin="anonymous"></script>
    <script src="~/lib/jquery-validate/jquery.validate.min.js"></script>
    <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
</body>

</html>